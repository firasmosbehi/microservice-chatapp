name: Microservice Unit Tests

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: read

jobs:
  run-unit-tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        service: [user-service, chat-service, message-service, gateway-service]
        include:
          - service: user-service
            language: node
            test-command: cd app/user-service && npm test tests/core-functions.test.js
            setup: |
              cd app/user-service
              npm install
          - service: chat-service
            language: python
            test-command: cd app/chat-service && python3 tests/structure_test.py
            setup: |
              # No setup needed for basic Python tests
          - service: message-service
            language: go
            test-command: cd app/message-service && go test ./tests/simple_test.go -v
            setup: |
              # Go setup happens automatically
          - service: gateway-service
            language: python
            test-command: cd app/gateway-service && python3 tests/basic_test.py
            setup: |
              # No setup needed for basic Python tests
      fail-fast: false  # Continue running other services even if one fails

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js (for user-service)
      if: matrix.language == 'node'
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: app/user-service/package-lock.json

    - name: Set up Python (for chat-service and gateway-service)
      if: matrix.language == 'python'
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Set up Go (for message-service)
      if: matrix.language == 'go'
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        cache: true

    - name: Service-specific setup
      run: |
        ${{ matrix.setup }}

    - name: Run tests for ${{ matrix.service }}
      run: |
        echo "ðŸš€ Running tests for ${{ matrix.service }}"
        echo "=================================="
        ${{ matrix.test-command }}

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.service }}
        path: |
          app/${{ matrix.service }}/tests/
          app/${{ matrix.service }}/coverage/
        if-no-files-found: ignore

  run-all-services-test:
    name: Run All Services Tests
    runs-on: ubuntu-latest
    needs: run-unit-tests
    if: success() || failure()  # Run even if some tests failed
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Install Python dependencies for master runner
      run: |
        python3 -m pip install --user pytest pytest-cov

    - name: Run master test suite
      run: |
        echo "ðŸš€ Running comprehensive test suite..."
        echo "====================================="
        python3 run_microservice_tests.py

    - name: Upload comprehensive test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: comprehensive-test-results
        path: |
          test-results/
          coverage-reports/
        if-no-files-found: ignore

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [run-unit-tests, run-all-services-test]
    if: always()
    
    steps:
    - name: Download all test artifacts
      uses: actions/download-artifact@v4
      with:
        path: test-artifacts

    - name: Generate test summary
      run: |
        echo "## ðŸ“Š Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Count passed/failed tests from artifacts
        echo "### Individual Service Tests" >> $GITHUB_STEP_SUMMARY
        echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
        
        for service in user-service chat-service message-service gateway-service; do
          if [ -d "test-artifacts/test-results-$service" ]; then
            echo "| $service | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| $service | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
        done
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Master Test Suite" >> $GITHUB_STEP_SUMMARY
        if [ -d "test-artifacts/comprehensive-test-results" ]; then
          echo "âœ… Master test suite completed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Master test suite failed" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Notify on failure
      if: failure()
      uses: sarisia/actions-status-discord@v1
      with:
        webhook: ${{ secrets.DISCORD_WEBHOOK }}
        status: failure
        title: "Microservice Tests Failed"
        description: "Some unit tests are failing in the CI pipeline"
        username: "CI Bot"
        avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"