name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Login to container registry
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Build and push frontend service
      working-directory: ./app/frontend-service
      run: |
        docker buildx build \
          --push \
          --tag ${{ secrets.DOCKER_USERNAME }}/chatapp-frontend:latest \
          --tag ${{ secrets.DOCKER_USERNAME }}/chatapp-frontend:${{ github.sha }} \
          .
    
    - name: Build and push user service
      working-directory: ./app/user-service
      run: |
        docker buildx build \
          --push \
          --tag ${{ secrets.DOCKER_USERNAME }}/chatapp-user:latest \
          --tag ${{ secrets.DOCKER_USERNAME }}/chatapp-user:${{ github.sha }} \
          .
    
    - name: Build and push chat service
      working-directory: ./app/chat-service
      run: |
        docker buildx build \
          --push \
          --tag ${{ secrets.DOCKER_USERNAME }}/chatapp-chat:latest \
          --tag ${{ secrets.DOCKER_USERNAME }}/chatapp-chat:${{ github.sha }} \
          .
    
    - name: Build and push message service
      working-directory: ./app/message-service
      run: |
        docker buildx build \
          --push \
          --tag ${{ secrets.DOCKER_USERNAME }}/chatapp-message:latest \
          --tag ${{ secrets.DOCKER_USERNAME }}/chatapp-message:${{ github.sha }} \
          .
    
    - name: Build and push gateway service
      working-directory: ./app/gateway-service
      run: |
        docker buildx build \
          --push \
          --tag ${{ secrets.DOCKER_USERNAME }}/chatapp-gateway:latest \
          --tag ${{ secrets.DOCKER_USERNAME }}/chatapp-gateway:${{ github.sha }} \
          .

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: production
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to production
      run: |
        echo "ðŸš€ Deploying to production environment..."
        echo "Services will be deployed with latest tags"
        # This would typically integrate with your deployment platform
        # Examples: Kubernetes, AWS ECS, Google Cloud Run, etc.
        
        # For demonstration, showing what deployment commands might look like:
        echo "Sample deployment commands:"
        echo "kubectl set image deployment/frontend-deployment frontend=${{ secrets.DOCKER_USERNAME }}/chatapp-frontend:latest"
        echo "kubectl set image deployment/user-deployment user=${{ secrets.DOCKER_USERNAME }}/chatapp-user:latest"
        echo "kubectl set image deployment/chat-deployment chat=${{ secrets.DOCKER_USERNAME }}/chatapp-chat:latest"
        echo "kubectl set image deployment/message-deployment message=${{ secrets.DOCKER_USERNAME }}/chatapp-message:latest"
        echo "kubectl set image deployment/gateway-deployment gateway=${{ secrets.DOCKER_USERNAME }}/chatapp-gateway:latest"